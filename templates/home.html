{% extends "base.html" %}
{% block title %}Home{% endblock %}

{% block content %}
<div class="container">
    {% if user.is_authenticated %}
        {% if user.is_staff or user.is_superuser %}
            <div class="mb-4">
                {% csrf_token %}
                <label for="buyerSelect" class="form-label">Wybierz kupującego:</label>
                <select class="form-select" id="buyerSelect" onchange="changeBuyer(this.value)">
                    <option value="">-- Wybierz --</option>
                    {% for beneficiary in beneficiaries %}
                        <option value="{{ beneficiary.id }}"
                                {% if selected_buyer.id == beneficiary.id %}selected{% endif %}>
                            {{ beneficiary.profile.name|default:beneficiary.username }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        {% endif %}
        <div class="row">
            <div class="col">
                <h1>Hello</h1>
                {{ selected_buyer }}
            </div>
        </div>

        {% if selected_buyer %}
            <div class="row row-cols-1 row-cols-md-3 g-4">
                {% csrf_token %}
                {% for product in products %}
                    <div class="col">
                        <div class="card h-100 product-card" 
                             data-product-id="{{ product.id }}"
                             {% for price in product.prices.all %}
                                 data-price-list-{{ price.price_list.id }}="{{ price.gross_price }}"
                             {% endfor %}>
                            {% if product.images.first %}
                                <div class="card-img-container pt-3" style="height: 200px; overflow: hidden; display: flex; align-items: center; justify-content: center;">
                                    <img src="{{ product.images.first.image.url }}" 
                                         alt="{{ product.name }}"
                                         style="max-height: 100%; max-width: 100%; object-fit: contain;">
                                </div>
                            {% endif %}
                            <div class="card-body">
                                <h5 class="card-title">{{ product.name }}</h5>
                                <p class="card-text">{{ product.description }}</p>
                                <p class="card-text price-display">
                                    <strong>Cena: <span class="price-value">
                                        {% with buyer_price_list=selected_buyer.profile.price_list %}
                                        {% if buyer_price_list %}
                                            {% with product_price=product.prices.all|dictsort:"price_list.id"|first %}
                                                {% if product_price %}
                                                    {{ product_price.gross_price }}
                                                {% else %}
                                                    -
                                                {% endif %}
                                            {% endwith %}
                                        {% else %}
                                            -
                                        {% endif %}
                                        {% endwith %}
                                    </span> zł</strong>
                                </p>
                                {% with buyer_price_list=selected_buyer.profile.price_list %}
                                {% if buyer_price_list %}
                                    {% with product_price=product.prices.all|dictsort:"price_list.id"|first %}
                                    {% if product_price %}
                                        <div class="add-to-cart-overlay">
                                            <div class="input-group">
                                                <input type="number" 
                                                       class="form-control" 
                                                       value="1" 
                                                       min="1"
                                                       id="quantity-{{ product.id }}">
                                                <button class="btn btn-success" 
                                                        onclick="addToCart({{ product.id }}, {{ selected_buyer.id }})">
                                                    <i class="bi bi-plus-lg"></i>
                                                </button>
                                            </div>
                                        </div>
                                    {% else %}
                                        <p class="text-muted">Brak ceny dla tego produktu</p>
                                    {% endif %}
                                    {% endwith %}
                                {% else %}
                                    <p class="text-muted">Brak przypisanego cennika dla kupującego</p>
                                {% endif %}
                                {% endwith %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-warning">
                Proszę wybrać kupującego aby zobaczyć produkty.
            </div>
        {% endif %}
    {% else %}
        <div class="alert alert-info">
            Zaloguj się aby zobaczyć produkty.
        </div>
    {% endif %}
</div>

<style>
    .product-card {
        position: relative;
    }

    .add-to-cart-overlay {
        position: absolute;
        bottom: 1rem;
        left: 1rem;
        right: 1rem;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .product-card:hover .add-to-cart-overlay {
        opacity: 1;
    }
</style>

{% block extra_js %}
<script>
    function changeBuyer(buyerId) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        if (!csrfToken) {
            console.error('CSRF token not found');
            return;
        }

        fetch('/change-buyer/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                buyer_id: buyerId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Reload the entire page to re-render with new buyer
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Wystąpił błąd podczas zmiany kupującego');
        });
    }

    function updatePrices(priceListId) {
        document.querySelectorAll('.product-card').forEach(card => {
            const priceValue = card.getAttribute(`data-price-list-${priceListId}`);
            const priceDisplay = card.querySelector('.price-value');
            if (priceValue) {
                priceDisplay.textContent = priceValue;
                card.querySelector('.add-to-cart-overlay').style.display = 'block';
            } else {
                priceDisplay.textContent = '-';
                card.querySelector('.add-to-cart-overlay').style.display = 'none';
            }
        });
    }

    function clearPrices() {
        document.querySelectorAll('.product-card').forEach(card => {
            const priceDisplay = card.querySelector('.price-value');
            priceDisplay.textContent = '-';
            card.querySelector('.add-to-cart-overlay').style.display = 'none';
        });
    }

    function addToCart(productId, buyerId) {
        const quantity = parseInt(document.getElementById(`quantity-${productId}`).value);

        fetch('/cart/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                product_id: productId,
                buyer_id: buyerId,
                quantity: quantity
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                updateCartIcon(data.cart_count);
                updateCartContent(data.cart_data);
                const sidebar = document.getElementById('cartSidebar');
                if (!sidebar.classList.contains('show')) {
                    sidebar.classList.add('show');
                }
            }
        })
        .catch(error => console.error('Error:', error));
    }

    function updateCartDisplay(cartData) {
        updateCartIcon(cartData ? cartData.items.length : 0);

        if (cartData) {
            updateCartContent(cartData);
        } else {
            // Clear cart if no data
            const cartContent = document.querySelector('#cartContent');
            if (cartContent) {
                cartContent.innerHTML = '<p class="text-center">Koszyk jest pusty</p>';
            }
        }
    }
</script>
{% endblock %}
{% endblock %}
