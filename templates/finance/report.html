{% extends "base.html" %}

{% block title %}Raport Finansowy{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Raport Finansowy</h2>
        <a href="{% url 'finance:main' %}" class="btn btn-secondary">
            <i class="bi bi-list me-2"></i>Lista płatności
        </a>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <form id="reportForm" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Raport za:</label>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="monthSelect">
                        <option value="1">Styczeń</option>
                        <option value="2">Luty</option>
                        <option value="3">Marzec</option>
                        <option value="4">Kwiecień</option>
                        <option value="5">Maj</option>
                        <option value="6">Czerwiec</option>
                        <option value="7">Lipiec</option>
                        <option value="8">Sierpień</option>
                        <option value="9">Wrzesień</option>
                        <option value="10">Październik</option>
                        <option value="11">Listopad</option>
                        <option value="12">Grudzień</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="yearSelect">
                        {% for year in years %}
                            <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="button" class="btn btn-primary" onclick="loadReport()">
                        <i class="bi bi-download me-2"></i>Pobierz płatności
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="reportContent" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0" id="reportTitle"></h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table" id="reportTable">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tytuł</th>
                                <th>Nadawca</th>
                                <th>Kwota</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Razem:</strong></td>
                                <td id="totalAmount"><strong>0.00 zł</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set default month (last month)
    const date = new Date();
    let currentMonth = date.getMonth() + 1; // JavaScript months are 0-based
    const currentYear = date.getFullYear();
    
    document.getElementById('monthSelect').value = currentMonth;
    document.getElementById('yearSelect').value = currentYear;
});

function loadReport() {
    const month = document.getElementById('monthSelect').value;
    const year = document.getElementById('yearSelect').value;
    
    fetch(`/finance/get-report-data/?month=${month}&year=${year}`)
        .then(response => response.json())
        .then(data => {
            displayReport(data, month, year);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Wystąpił błąd podczas pobierania danych');
        });
}

function displayReport(data, month, year) {
    const monthNames = [
        'Styczeń', 'Luty', 'Marzec', 'Kwiecień', 'Maj', 'Czerwiec',
        'Lipiec', 'Sierpień', 'Wrzesień', 'Październik', 'Listopad', 'Grudzień'
    ];
    
    document.getElementById('reportTitle').textContent = 
        `Zestawienie pozarachunkowej sprzedaży brutto - ${monthNames[month-1]} ${year}r.`;
    
    const tbody = document.getElementById('reportTableBody');
    let total = 0;
    
    tbody.innerHTML = data.payments.map(payment => {
        total += parseFloat(payment.amount);
        return `
            <tr>
                <td>${payment.payment_date}</td>
                <td>${payment.description}</td>
                <td>${payment.sender || '-'}</td>
                <td class="${payment.amount >= 0 ? 'text-success' : 'text-danger'}">
                    ${payment.amount} zł
                </td>
            </tr>
        `;
    }).join('');

    document.getElementById('totalAmount').innerHTML = 
        `<strong class="${total >= 0 ? 'text-success' : 'text-danger'}">${total.toFixed(2)} zł</strong>`;

    document.getElementById('reportContent').style.display = 'block';
}
</script>
{% endblock %}
{% endblock %} 
